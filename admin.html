<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Admin Panel</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        const role = sessionStorage.getItem('adminRole');
        if (!role || (role !== 'admin' && role !== 'super_admin')) {
            window.location.href = 'index.html';
        }
    </script>
    <style>
        .admin-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        .user-list {
            margin-top: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-front-desk {
            background: #e0f2fe;
            color: #0369a1;
        }

        .badge-care-prof {
            background: #dcfce7;
            color: #15803d;
        }

        .super-admin-only {
            display: none;
        }
    </style>
</head>

<body>
    <header class="header" style="padding: 2rem 1rem;">
        <div class="header-content"
            style="max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; gap: 20px;">
            <div>
                <h1 class="hospital-name" style="font-size: 2.5rem; margin-bottom: 5px;">Admin Panel</h1>
                <p class="hospital-tagline">User Management <span id="adminBadge"></span></p>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button onclick="showWhatsNew()" class="btn btn-secondary"
                    style="background: rgba(255,255,255,0.2); color: white; border: none;">What's New</button>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </header>

    <main class="admin-container">
        <!-- Super Admin Section -->
        <div id="superAdminSection" class="module-card super-admin-only"
            style="margin-bottom: 30px; border: 2px solid var(--primary-500);">
            <h2 class="module-title" style="color: var(--primary-600);">Super Admin Controls</h2>
            <div class="form-group">
                <label class="form-label">Update Main Admin Password</label>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="newAdminPassword" class="form-input" placeholder="New 'helloadmin' password">
                    <button onclick="updateAdminPassword()" class="btn btn-primary">Update</button>
                </div>
            </div>

            <div style="border-top: 1px solid #eee; padding-top: 20px;">
                <h3 style="color: #dc2626; margin-bottom: 10px;">Destructive Actions</h3>
                <button onclick="confirmDeleteAllData()" class="btn btn-primary"
                    style="background: #dc2626; border-color: #b91c1c;">
                    ‚ö†Ô∏è Delete All Data (Reset System)
                </button>
                <p style="color: #666; font-size: 0.9em; margin-top: 5px;">This will permanently delete ALL patients and
                    consultations.</p>
            </div>
        </div>

        <!-- Create User -->
        <div class="module-card">
            <h2 class="module-title">Create New User</h2>
            <form id="createUserForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="newUsername" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="newPassword" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select id="newRole" class="form-select" required>
                            <option value="front_desk">Front Desk (Registration)</option>
                            <option value="care_professional">Care Professional (Consultation)</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-4">Create User</button>
            </form>
        </div>

        <!-- User List -->
        <div class="user-list">
            <h3 style="padding: 20px; border-bottom: 1px solid #eee;">Active Users</h3>
            <div class="table-responsive">
                <div id="usersListContainer">
                    <div style="padding: 20px; text-align: center;">Loading...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Custom Modal -->
    <div id="customConfirmOverlay" class="custom-confirm-overlay">
        <div class="custom-confirm-box">
            <div class="confirm-title" id="confirmTitle">Admin Panel</div>
            <div class="confirm-msg" id="confirmMessage">Are you sure?</div>
            <input type="text" id="confirmInput" class="confirm-input" placeholder="" autocomplete="off">
            <div class="confirm-actions">
                <button class="btn-confirm btn-confirm-cancel" id="confirmCancelBtn">Cancel</button>
                <button class="btn-confirm btn-confirm-ok" id="confirmOkBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
        // Loading Handler
        function setLoading(active, text = "Loading...") {
            const loader = document.getElementById('globalLoader');
            const loaderText = document.getElementById('loaderText');
            if (!loader) return;
            if (active) {
                loaderText.textContent = text;
                loader.classList.add('active');
            } else {
                loader.classList.remove('active');
            }
        }

        // Custom UI
        function showCustomConfirm(message, onYes) {
            const overlay = document.getElementById('customConfirmOverlay');
            document.getElementById('confirmMessage').innerHTML = message; // innerHTML support
            document.getElementById('confirmTitle').textContent = 'Confirm Action';
            const inputEl = document.getElementById('confirmInput');
            if (inputEl) inputEl.style.display = 'none';
            const cancelBtn = document.getElementById('confirmCancelBtn');
            const okBtn = document.getElementById('confirmOkBtn');
            cancelBtn.style.display = 'inline-block';
            okBtn.textContent = 'OK';
            overlay.classList.add('active');
            const close = () => overlay.classList.remove('active');
            cancelBtn.onclick = close;
            okBtn.onclick = () => { close(); if (onYes) onYes(); };
        }

        function showCustomAlert(message) {
            const overlay = document.getElementById('customConfirmOverlay');
            document.getElementById('confirmMessage').innerHTML = message; // innerHTML support
            document.getElementById('confirmTitle').textContent = 'Notification';
            const inputEl = document.getElementById('confirmInput');
            if (inputEl) inputEl.style.display = 'none';
            document.getElementById('confirmCancelBtn').style.display = 'none';
            document.getElementById('confirmOkBtn').textContent = 'OK';
            overlay.classList.add('active');
            document.getElementById('confirmOkBtn').onclick = () => overlay.classList.remove('active');
        }

        function showCustomPrompt(message, onResult, isPassword = false, defaultValue = '') {
            const overlay = document.getElementById('customConfirmOverlay');
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmTitle').textContent = 'Input Required';
            const inputEl = document.getElementById('confirmInput');
            const cancelBtn = document.getElementById('confirmCancelBtn');
            const okBtn = document.getElementById('confirmOkBtn');

            inputEl.style.display = 'block';
            inputEl.type = isPassword ? 'password' : 'text';
            inputEl.value = defaultValue;
            inputEl.placeholder = '';
            setTimeout(() => inputEl.focus(), 100);

            cancelBtn.style.display = 'inline-block';
            okBtn.textContent = 'OK';
            overlay.classList.add('active');

            const close = () => { overlay.classList.remove('active'); inputEl.style.display = 'none'; };
            const submit = () => { const val = inputEl.value; close(); if (onResult) onResult(val); };
            cancelBtn.onclick = () => { close(); if (onResult) onResult(null); };
            okBtn.onclick = submit;
            inputEl.onkeydown = (e) => { if (e.key === 'Enter') submit(); if (e.key === 'Escape') cancelBtn.click(); };
        }

        function showWhatsNew() {
            const html = `
                <div style="text-align: left;">
                    <h3>Latest Features (v1.2)</h3>
                    <ul style="padding-left: 20px; line-height: 1.6;">
                        <li>üîí <strong>Super Admin</strong>: Secure user management.</li>
                        <li>üåô <strong>Dark UI</strong>: New premium popups.</li>
                        <li>üñ®Ô∏è <strong>Reprint</strong>: History access for closed patients.</li>
                        <li>üìÑ <strong>PDF Style</strong>: Added professional borders.</li>
                    </ul>
                </div>
            `;
            showCustomAlert(html);
        }

        // Logic
        const currentRole = sessionStorage.getItem('adminRole');
        if (currentRole === 'super_admin') {
            document.querySelectorAll('.super-admin-only').forEach(el => el.style.display = 'block');
            document.getElementById('adminBadge').textContent = '(Super Admin)';
            document.getElementById('adminBadge').style.color = 'red';
        } else {
            document.getElementById('adminBadge').textContent = '(Admin)';
        }

        function loadUsers() {
            setLoading(true, "Fetching Users...");
            const container = document.getElementById('usersListContainer');
            if (!window.db) {
                setLoading(false);
                container.innerHTML = 'Error: DB not connected';
                return;
            }
            db.collection('users').get().then(snapshot => {
                let html = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const badgeClass = user.role === 'front_desk' ? 'badge-front-desk' : 'badge-care-prof';
                    const roleName = user.role === 'front_desk' ? 'Front Desk' : 'Care Professional';
                    const displayName = user.username || '<span style="color:red;">(Missing Username)</span>';
                    let actions = `<button onclick="confirmDelete('${doc.id}')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px; background: #fee2e2; color: #b91c1c;">Delete</button>`;
                    if (currentRole === 'super_admin') {
                        actions = `<button onclick="editUser('${doc.id}', '${user.username || ''}')" class="btn btn-primary" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;">Edit</button>${actions}`;
                    }
                    html += `<div class="user-item"><div><strong>${displayName}</strong><span class="badge ${badgeClass}" style="margin-left:8px;">${roleName}</span></div><div>${actions}</div></div>`;
                });
                if (html === '') html = '<div style="padding: 20px; text-align: center;">No users found.</div>';
                container.innerHTML = html;
                setLoading(false);
            }).catch(e => {
                setLoading(false);
                showCustomAlert("Error fetching users: " + e.message);
            });
        }

        document.getElementById('createUserForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;
            setLoading(true, "Creating User...");
            db.collection('users').add({ username, password, role, createdAt: new Date().toISOString() })
                .then(() => {
                    setLoading(false);
                    showCustomAlert('User created');
                    document.getElementById('createUserForm').reset();
                    loadUsers();
                })
                .catch(err => {
                    setLoading(false);
                    showCustomAlert('Error: ' + err.message);
                });
        });

        window.confirmDelete = function (id) {
            showCustomConfirm('Delete this user?', () => {
                setLoading(true, "Deleting User...");
                db.collection('users').doc(id).delete().then(() => {
                    setLoading(false);
                    loadUsers();
                }).catch(e => {
                    setLoading(false);
                    showCustomAlert("Error: " + e.message);
                });
            });
        };

        window.editUser = function (id, currentName) {
            showCustomPrompt("Edit Username:", (newName) => {
                if (!newName) return;
                showCustomPrompt("Enter New Password (leave empty to keep):", (newPass) => {
                    if (newPass === null) return;
                    let updates = { username: newName };
                    if (newPass.trim() !== "") updates.password = newPass;
                    db.collection('users').doc(id).update(updates).then(() => { showCustomAlert('Updated!'); loadUsers(); });
                }, true);
            }, false, currentName);
        };

        window.updateAdminPassword = function () {
            const newPass = document.getElementById('newAdminPassword').value;
            if (!newPass) return showCustomAlert('Enter password');
            showCustomConfirm('Change Main Admin Password?', () => {
                db.collection('settings').doc('admin_config').set({ adminPassword: newPass })
                    .then(() => showCustomAlert('Updated!'));
            });
        }

        window.confirmDeleteAllData = function () {
            showCustomPrompt("ENTER SUPER ADMIN PASSWORD:", (pass) => {
                if (pass !== 'helloarbazgazge') {
                    showCustomAlert("Incorrect Password. Action cancelled.");
                    return;
                }

                showCustomConfirm("DANGER: This will delete ALL Patients and Consultations. Are you absolutely sure?", () => {
                    // Logic to delete collections
                    const deleteCollection = async (coll) => {
                        const batchLimit = 500;
                        const snap = await db.collection(coll).get();
                        if (snap.size === 0) return 0;

                        const batch = db.batch();
                        snap.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        return snap.size;
                    };

                    setLoading(true, "Resetting System... Please Wait");

                    Promise.all([deleteCollection('patients'), deleteCollection('consultations')])
                        .then(() => {
                            setLoading(false);
                            showCustomAlert("System Reset Complete. All data deleted.");
                        })
                        .catch(err => {
                            setLoading(false);
                            showCustomAlert("Error: " + err.message);
                        });
                });
            }, true);
        };

        function logout() {
            setLoading(true, "Logging out...");
            setTimeout(() => {
                sessionStorage.removeItem('adminRole');
                window.location.href = 'index.html';
            }, 500);
        }
        loadUsers();
    </script>
    <!-- Global Loader -->
    <div id="globalLoader" class="loader-overlay">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loaderText">Loading...</div>
    </div>
</body>

</html>